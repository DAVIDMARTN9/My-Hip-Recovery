<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Hip Replacement Recovery Diary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .container-wrapper { background-color: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.08); padding: 1.5rem; max-width: 900px; margin: 2rem auto; width: 95%; }
        @media (min-width: 640px) { .container-wrapper { padding: 2.5rem; } }
        @media (min-width: 768px) { .container-wrapper { padding: 3rem; } }
        .diary-nav-button { background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: inline-flex; align-items: center; justify-content: center; }
        .diary-nav-button:hover { background-color: #4338ca; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .diary-nav-button:disabled { background-color: #a7b0bd; cursor: not-allowed; transform: none; box-shadow: none; }
        .day-selector-button { background-color: #eef2ff; color: #4f46e5; padding: 0.6rem 1rem; border-radius: 0.6rem; font-weight: 500; transition: all 0.2s ease-in-out; border: 1px solid #c3daff; white-space: nowrap; }
        .day-selector-button:hover { background-color: #c7d2fe; transform: translateY(-1px); }
        .day-selector-button.active { background-color: #4f46e5; color: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transform: translateY(0); }
        .content-card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.1), 0 3px 6px -2px rgba(0, 0, 0, 0.05); padding: 2rem; margin-top: 2rem; line-height: 1.7; color: #374151; }
        .prose strong { color: #3730a3; }
        .language-toggle-button { background-color: #dc2626; color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .language-toggle-button:hover { background-color: #b91c1c; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .diary-image { max-width: 100%; height: auto; border-radius: 0.75rem; box-shadow: 0 3px 8px rgba(0,0,0,0.15); margin-top: 1.5rem; margin-bottom: 1.5rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; padding-left: 0; list-style-position: outside; }
        .prose li { margin-bottom: 0.75em; }
        .prose p + p { margin-top: 1.25em; }
        .chart-container { position: relative; width: 100%; max-width: 700px; margin-left: auto; margin-right: auto; height: 350px; max-height: 450px; background-color: #fbfbfc; border-radius: 1rem; box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.08), 0 3px 6px -2px rgba(0, 0, 0, 0.03); padding: 1.5rem; border: 1px solid #e0e7ff; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .exercise-details-card { background-color: #fbfbfc; border-radius: 1rem; box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.08), 0 3px 6px -2px rgba(0, 0, 0, 0.03); padding: 2rem; margin-top: 2rem; border: 1px solid #e0e7ff; }
        .day0-highlight { color: #dc2626; }
        .week-summary-highlight { color: #0d9488; }
        .prose h3 { color: #1a2b4b; font-weight: 700; }
        .prose h4 { color: #374151; font-weight: 600; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">
    <div class="container-wrapper">
        <div class="flex justify-end mb-6 gap-3">
            <button id="language-toggle" class="language-toggle-button">üá™üá∏ Espa√±ol</button>
            <button id="toggle-progress-button" class="diary-nav-button">üìä Show Progress</button>
        </div>
        <header class="text-center mb-10">
            <h1 id="main-title" class="text-4xl sm:text-5xl font-extrabold text-gray-900 leading-tight"></h1>
            <p id="subtitle" class="text-gray-600 mt-4 text-xl font-medium"></p>
        </header>
        <nav class="mb-8">
            <div id="day-selector-container" class="flex flex-wrap justify-center gap-2.5 mb-6"></div>
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <button id="prev-day-button" class="diary-nav-button w-full sm:w-auto"></button>
                <h2 id="current-day-title" class="text-2xl sm:text-3xl font-semibold text-gray-800 text-center mx-4 flex-grow"></h2>
                <button id="next-day-button" class="diary-nav-button w-full sm:w-auto"></button>
            </div>
        </nav>
        <main id="diary-entry-content" class="content-card prose lg:prose-xl max-w-none">
            <p>Loading diary...</p>
        </main>
        <section id="progress-section" class="hidden mt-10">
            <h3 id="progress-title" class="text-3xl font-bold text-gray-800 mb-5 text-center"></h3>
            <p id="progress-description" class="text-gray-600 mb-8 text-center text-lg"></p>
            <div class="chart-container"><canvas id="exerciseProgressChart"></canvas></div>
            <h3 id="weekly-progress-title" class="text-3xl font-bold text-gray-800 mb-5 text-center mt-10"></h3>
            <p id="weekly-progress-description" class="text-gray-600 mb-8 text-center text-lg"></p>
            <div class="chart-container"><canvas id="weeklyComparisonChart"></canvas></div>
            <div class="exercise-details-card prose lg:prose-xl max-w-none mt-8">
                <h4 id="exercise-details-title" class="text-2xl font-semibold text-gray-700 mb-5"></h4>
                <div id="current-day-stats" class="text-lg text-gray-800 mb-6 space-y-2"></div>
                <ul id="exercise-list" class="list-disc ml-6"></ul>
            </div>
        </section>
        <footer class="text-center mt-16 text-gray-500 text-sm">
            <p id="footer-text" class="text-base"></p>
        </footer>
    </div>
<script>
// --- DATA ---
const strengthRoutineEN = [
    { name: "1. Heel raises", desc: "..." }, { name: "2. Mini squat with support", desc: "..." },
    { name: "3. Active knee flexion in standing", desc: "..." }, { name: "4. Hip abduction in standing", desc: "..." },
    { name: "5. Standing hip flexion", desc: "..." }, { name: "6. Hip extension in standing", desc: "..." },
    { name: "7. Abdominal exercises", desc: "..." }, { name: "8. Hamstring Stretches", desc: "..." },
    { name: "9. Glute Bridges", desc: "..." }, { name: "10. Dead Weight Lift (with bar)", desc: "..." },
    { name: "11. Single-Leg Squats", desc: "..." }, { name: "12. Push-ups", desc: "..." },
    { name: "13. Shoulder Flies", desc: "..." }, { name: "14. Biceps Curl", desc: "..." },
    { name: "15. Tricep Dips", desc: "..." }
];
const strengthRoutineES = [
    { name: "1. Elevaci√≥n de talones", desc: "..." }, { name: "2. Mini sentadilla con apoyo", desc: "..." },
    { name: "3. Flexi√≥n activa de rodilla de pie", desc: "..." }, { name: "4. Abducci√≥n de cadera de pie", desc: "..." },
    { name: "5. Flexi√≥n de cadera de pie", desc: "..." }, { name: "6. Extensi√≥n de cadera de pie", desc: "..." },
    { name: "7. Ejercicios abdominales", desc: "..." }, { name: "8. Estiramientos de isquiotibiales", desc: "..." },
    { name: "9. Puentes de gl√∫teos", desc: "..." }, { name: "10. Peso Muerto (con barra)", desc: "..." },
    { name: "11. Sentadillas a una pierna", desc: "..." }, { name: "12. Flexiones", desc: "..." },
    { name: "13. Elevaciones laterales de hombros", desc: "..." }, { name: "14. Curl de b√≠ceps", desc: "..." },
    { name: "15. Fondos de Tr√≠ceps", desc: "..." }
];
const stretchingRoutineEN = [ { name: "1. Core Engagement", desc: "..." }, { name: "2. Hamstring Stretches", desc: "..." }, { name: "3. Glute Bridges / Hip Thrusts", desc: "..." }, { name: "4. Supine Hip Elevations", desc: "..." }, { name: "5. Low Back & Abdominal Stretch", desc: "..." }];
const stretchingRoutineES = [ { name: "1. Activaci√≥n de Core", desc: "..." }, { name: "2. Estiramientos de Isquiotibiales", desc: "..." }, { name: "3. Puentes de Gl√∫teos / Empuje de Cadera", desc: "..." }, { name: "4. Elevaciones de Cadera en Supino", desc: "..." }, { name: "5. Estiramiento Lumbar y Abdominal", desc: "..." }];
// NOTE: All long diary entry content has been removed here for brevity but should be in your final code.

const diaryEntriesBase = [
    { id: "day-minus-1", date: "2025-05-26", title: "Day -1: Monday, May 26, 2025", shortTitle: "Day -1", contentEN: `...`, contentES: `...` },
    { id: "day-0", date: "2025-05-27", title: "Day 0: Tuesday, May 27, 2025 ‚Äì <span class='day0-highlight'>Surgery Day</span>", shortTitle: "Day 0", contentEN: `...`, contentES: `...` },
    { id: "day-1", date: "2025-05-28", title: "Day 1: Wednesday, May 28, 2025 ‚Äì First Day Home", shortTitle: "Day 1", exerciseSets: 2, moveKcals: 361, exerciseMinutes: 10, standHours: 20, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-2", date: "2025-05-29", title: "Day 2: Thursday, May 29, 2025", shortTitle: "Day 2", exerciseSets: 6, moveKcals: 295, exerciseMinutes: 30, standHours: 13, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-3", date: "2025-05-30", title: "Day 3: Friday, May 30, 2025", shortTitle: "Day 3", exerciseSets: 10, moveKcals: 282, exerciseMinutes: 50, standHours: 15, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-4", date: "2025-05-31", title: "Day 4: Saturday, May 31, 2025", shortTitle: "Day 4", exerciseSets: 12, moveKcals: 570, exerciseMinutes: 108, standHours: 17, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-5", date: "2025-06-01", title: "Day 5: Sunday, June 1, 2025", shortTitle: "Day 5", exerciseSets: 10, moveKcals: 537, exerciseMinutes: 89, standHours: 15, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-6", date: "2025-06-02", title: "Day 6: Monday, June 2, 2025", shortTitle: "Day 6", exerciseSets: 10, moveKcals: 586, exerciseMinutes: 101, standHours: 10, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-7", date: "2025-06-03", title: "Day 7: Tuesday, June 3, 2025", shortTitle: "Day 7", exerciseSets: 10, moveKcals: 585, exerciseMinutes: 96, standHours: 15, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "week-1-summary", date: "2025-06-03", title: "Week 1 Summary: Days 1 to 7", shortTitle: "Week 1", isSummary: true, contentEN: `...`, contentES: `...` },
    { id: "day-8", date: "2025-06-04", title: "Day 8: Wednesday, June 4, 2025", shortTitle: "Day 8", exerciseSets: 8, moveKcals: 655, exerciseMinutes: 91, standHours: 12, walkDistanceKm: 1.34, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-9", date: "2025-06-05", title: "Day 9: Thursday, June 5, 2025", shortTitle: "Day 9", exerciseSets: 5, moveKcals: 565, exerciseMinutes: 74, standHours: 16, walkDistanceKm: 0, isRestDay: true, contentEN: `...`, contentES: `...` },
    { id: "day-10", date: "2025-06-06", title: "Day 10: Friday, June 6, 2025", shortTitle: "Day 10", exerciseSets: 8, moveKcals: 584, exerciseMinutes: 80, standHours: 15, walkDistanceKm: 1.36, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-11", date: "2025-06-07", title: "Day 11: Saturday, June 7, 2025", shortTitle: "Day 11", exerciseSets: 10, moveKcals: 598, exerciseMinutes: 96, standHours: 18, walkDistanceKm: 0, numExercises: 6, contentEN: `...`, contentES: `...` },
    { id: "day-12", date: "2025-06-08", title: "Day 12: Sunday, June 8, 2025", shortTitle: "Day 12", exerciseSets: 8, moveKcals: 694, exerciseMinutes: 107, standHours: 16, walkDistanceKm: 0, numExercises: 9, contentEN: `...`, contentES: `...` },
    { id: "day-13", date: "2025-06-09", title: "Day 13: Monday, June 9, 2025", shortTitle: "Day 13", exerciseSets: 7, moveKcals: 733, exerciseMinutes: 100, standHours: 15, walkDistanceKm: 0, numExercises: 9, contentEN: `...`, contentES: `...` },
    { id: "day-14", date: "2025-06-10", title: "Day 14: Tuesday, June 10, 2025", shortTitle: "Day 14", exerciseSets: 8, moveKcals: 756, exerciseMinutes: 130, standHours: 15, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "week-2-summary", date: "2025-06-10", title: "Week 2 Summary: Days 8 to 14", shortTitle: "Week 2", isSummary: true, contentEN: `...`, contentES: `...` },
    { id: "day-15", date: "2025-06-11", title: "Day 15: Wednesday, June 11, 2025", shortTitle: "Day 15", exerciseSets: 8, moveKcals: 762, exerciseMinutes: 124, standHours: 16, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-16", date: "2025-06-12", title: "Day 16: Thursday, June 12, 2025", shortTitle: "Day 16", exerciseSets: 8, moveKcals: 712, exerciseMinutes: 126, standHours: 18, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-17", date: "2025-06-13", title: "Day 17: Friday, June 13, 2025", shortTitle: "Day 17", exerciseSets: 8, moveKcals: 801, exerciseMinutes: 129, standHours: 15, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-18", date: "2025-06-14", title: "Day 18: Saturday, June 14, 2025", shortTitle: "Day 18", exerciseSets: 7, moveKcals: 811, exerciseMinutes: 137, standHours: 19, walkDistanceKm: 1.5, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-19", date: "2025-06-15", title: "Day 19: Sunday, June 15, 2025", shortTitle: "Day 19", exerciseSets: 8, moveKcals: 867, exerciseMinutes: 161, standHours: 15, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-20", date: "2025-06-16", title: "Day 20: Monday, June 16, 2025 ‚Äì Back on the Bike!", shortTitle: "Day 20", exerciseSets: 6, moveKcals: 692, exerciseMinutes: 84, standHours: 14, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-21", date: "2025-06-17", title: "Day 21: Tuesday, June 17, 2025 ‚Äì Consistent Progress", shortTitle: "Day 21", exerciseSets: 6, moveKcals: 772, exerciseMinutes: 141, standHours: 13, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "week-3-summary", date: "2025-06-18", title: "Week 3 Summary: Days 15 to 21", shortTitle: "Week 3", isSummary: true, contentEN: `...`, contentES: `...` },
    { id: "day-22", date: "2025-06-18", title: "Day 22: Wednesday, June 18, 2025 ‚Äì Pushing the Limits", shortTitle: "Day 22", exerciseSets: 7, moveKcals: 917, exerciseMinutes: 167, standHours: 13, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-23", date: "2025-06-19", title: "Day 23: Thursday, June 19, 2025 ‚Äì A Calmer Day", shortTitle: "Day 23", exerciseSets: 6, moveKcals: 686, exerciseMinutes: 110, standHours: 16, walkDistanceKm: 0, numExercises: 12, contentEN: `...`, contentES: `...` },
    { id: "day-24", date: "2025-06-20", title: "Day 24: Friday, June 20, 2025 ‚Äì Increasing Intensity", shortTitle: "Day 24", exerciseSets: 6, moveKcals: 855, exerciseMinutes: 160, standHours: 13, walkDistanceKm: 0, numExercises: 15, contentEN: `...`, contentES: `...` },
    { id: "day-25", date: "2025-06-21", title: "Day 25: Saturday, June 21, 2025 ‚Äì A Long Walk", shortTitle: "Day 25", exerciseSets: 3, moveKcals: 855, exerciseMinutes: 142, standHours: 15, walkDistanceKm: 2.5, numExercises: 15, contentEN: `...`, contentES: `...` },
    { id: "day-26", date: "2025-06-22", title: "Day 26: Sunday, June 22, 2025 ‚Äì Steady Progress", shortTitle: "Day 26", exerciseSets: 6, moveKcals: 832, exerciseMinutes: 138, standHours: 13, walkDistanceKm: 0.5, numExercises: 15, contentEN: `...`, contentES: `...` }
];

// --- AGILE CONFIGURATION FOR BUTTON LAYOUT ---
// To add/reorder buttons, just change this array. The code will adapt automatically.
const buttonLayout = [
    'day--1', 'day-0', 'day-1', 'day-2', 'day-3', 'day-4', 'day-5', 'day-6', 'day-7',
    'week-1-summary',
    'day-8', 'day-9', 'day-10', 'day-11', 'day-12', 'day-13', 'day-14',
    'week-2-summary',
    'day-15', 'day-16', 'day-17', 'day-18', 'day-19', 'day-20', 'day-21',
    'week-3-summary', // --- MOVED AS REQUESTED ---
    'day-22', 'day-23', 'day-24', 'day-25', 'day-26'
];

const uiTexts = {
    en: { mainTitle: "My Hip Replacement Recovery Diary", subtitle: "Navigating recovery, one day at a time. Every step is progress.", prevButton: "Previous Day", nextButton: "Next Day", footer: "&copy; 2025 My Recovery Journey. All rights reserved.", toggleTo: "üá™üá∏ Espa√±ol", showProgress: "üìä Show Progress", hideProgress: "üìä Hide Progress", progressTitle: "Exercise Progress", progressDescription: "This chart visualizes the number of exercise sets completed each day, tracking your progress since the surgery, and other vital metrics.", weeklyProgressTitle: "Weekly Volume Comparison", weeklyProgressDescription: "Compare your total weekly exercise volumes to visualize consistent growth and recovery milestones.", chartLabelSets: "Sets Completed (x5)", chartLabelKcals: "Move (KCAL / 10)", chartLabelExerciseMinutes: "Exercise (minutes)", chartLabelStandHours: "Stand (hours)", chartLabelWalkDistance: "Walk Distance (km)", dailyExerciseBreakdown: "Daily Exercise Breakdown", setsCompleted: "Sets Completed:", totalExerciseTime: "Total Exercise Time:", minutes: "minutes", exerciseInstructions: "Exercise Instructions:", restDayRoutine: "Rest Day Stretching Routine:", noExercises: "No exercises recorded for this day.", walkDistance: "Walk Distance:", dayPrefix: "Day", weekPrefix: "Week" },
    es: { mainTitle: "Mi Diario de Recuperaci√≥n de Reemplazo de Cadera", subtitle: "Proceso de recuperaci√≥n. Partido a partido. Cada paso es progreso.", prevButton: "D√≠a Anterior", nextButton: "D√≠a Siguiente", footer: "&copy; 2025 Mi Viaje de Recuperaci√≥n. Todos los derechos reservados.", toggleTo: "üá¨üáß English", showProgress: "üìä Mostrar Progreso", hideProgress: "üìä Ocultar Progreso", progressTitle: "Progreso de Ejercicios", progressDescription: "Este gr√°fico visualiza el n√∫mero de series de ejercicios completadas cada d√≠a, ¬°siguiendo tu progreso desde la cirug√≠a, y otras m√©tricas vitales!", weeklyProgressTitle: "Comparaci√≥n de Volumen Semanal", weeklyProgressDescription: "Compara tus vol√∫menes totales de ejercicio semanales para visualizar el crecimiento constante y los hitos de recuperaci√≥n.", chartLabelSets: "Series Completadas (x5)", chartLabelKcals: "Movimiento (KCAL / 10)", chartLabelExerciseMinutes: "Ejercicio (minutos)", chartLabelStandHours: "De Pie (horas)", chartLabelWalkDistance: "Distancia Caminada (km)", dailyExerciseBreakdown: "Detalle de Ejercicios Diarios", setsCompleted: "Series Completadas:", totalExerciseTime: "Tiempo Total de Ejercicio:", minutes: "minutos", exerciseInstructions: "Instrucciones de Ejercicio:", restDayRoutine: "Rutina de Estiramientos (D√≠a de Descanso):", noExercises: "¬°No se registraron ejercicios para este d√≠a!", walkDistance: "Distancia Caminada:", dayPrefix: "D√≠a", weekPrefix: "Semana" }
};

// --- STATE & DOM ELEMENTS ---
let currentEntryIndex;
let currentLanguage = 'en';
let exerciseChart = null;
let weeklyChart = null;

const dom = {
    diaryContent: document.getElementById('diary-entry-content'),
    currentDayTitle: document.getElementById('current-day-title'),
    prevDayButton: document.getElementById('prev-day-button'),
    nextDayButton: document.getElementById('next-day-button'),
    daySelectorContainer: document.getElementById('day-selector-container'),
    languageToggleButton: document.getElementById('language-toggle'),
    toggleProgressButton: document.getElementById('toggle-progress-button'),
    progressSection: document.getElementById('progress-section'),
    mainTitle: document.getElementById('main-title'),
    subtitle: document.getElementById('subtitle'),
    progressTitle: document.getElementById('progress-title'),
    progressDescription: document.getElementById('progress-description'),
    weeklyProgressTitle: document.getElementById('weekly-progress-title'),
    weeklyProgressDescription: document.getElementById('weekly-progress-description'),
    exerciseDetailsTitle: document.getElementById('exercise-details-title'),
    currentDayStats: document.getElementById('current-day-stats'),
    exerciseList: document.getElementById('exercise-list'),
    footerText: document.getElementById('footer-text'),
    exerciseChartCanvas: document.getElementById('exerciseProgressChart'),
    weeklyChartCanvas: document.getElementById('weeklyComparisonChart'),
};

const entriesMap = new Map(diaryEntriesBase.map(entry => [entry.id.replace('day-minus','day--'), entry]));
const orderedEntries = buttonLayout.map(id => entriesMap.get(id)).filter(Boolean);

// --- UI UPDATE FUNCTIONS ---
function updateUIText() {
    const texts = uiTexts[currentLanguage];
    for (const key in texts) {
        const element = dom[key.replace(/Button|Text|Title|Description/i, '')] || document.getElementById(key);
        if (element) {
            element.innerHTML = texts[key];
        }
    }
    dom.toggleProgressButton.textContent = dom.progressSection.classList.contains('hidden') ? texts.showProgress : texts.hideProgress;
    updateAllCharts();
}

function updateDiaryDisplay() {
    const entry = orderedEntries[currentEntryIndex];
    if (!entry) return;

    dom.currentDayTitle.innerHTML = currentLanguage === 'es' ? translateTitle(entry.title) : entry.title;
    dom.diaryContent.innerHTML = entry[`content${currentLanguage.toUpperCase()}`] || entry.contentEN;

    dom.prevDayButton.disabled = currentEntryIndex === 0;
    dom.nextDayButton.disabled = currentEntryIndex === orderedEntries.length - 1;

    document.querySelectorAll('.day-selector-button').forEach((button, index) => {
        button.classList.toggle('active', index === currentEntryIndex);
    });

    if (!dom.progressSection.classList.contains('hidden')) {
        updateExerciseDetails();
    }
}

function populateDaySelectors() {
    dom.daySelectorContainer.innerHTML = '';
    orderedEntries.forEach((entry, index) => {
        const button = document.createElement('button');
        button.textContent = entry.shortTitle.replace(/Day|Week/g, word => uiTexts[currentLanguage][`${word.toLowerCase()}Prefix`]);
        button.className = 'day-selector-button';
        if (entry.isSummary) button.classList.add('week-summary-highlight');
        if (entry.id === 'day-0') button.classList.add('day0-highlight');
        button.addEventListener('click', () => {
            currentEntryIndex = index;
            updateDiaryDisplay();
        });
        dom.daySelectorContainer.appendChild(button);
    });
}

function updateExerciseDetails() {
    const entry = orderedEntries[currentEntryIndex];
    const texts = uiTexts[currentLanguage];
    if (!entry || entry.isSummary) {
        dom.currentDayStats.innerHTML = '';
        dom.exerciseList.innerHTML = '';
        return;
    }

    dom.currentDayStats.innerHTML = `
        ${texts.setsCompleted} <strong>${entry.exerciseSets || 0}</strong><br>
        ${texts.totalExerciseTime} <strong>${entry.exerciseMinutes || 0} ${texts.minutes}</strong><br>
        ${(texts.chartLabelKcals || '').replace(' (KCAL / 10)', '')}: <strong>${entry.moveKcals || 0} KCAL</strong><br>
        ${texts.chartLabelStandHours}: <strong>${entry.standHours || 0} hours</strong><br>
        ${texts.walkDistance} <strong>${(entry.walkDistanceKm || 0).toFixed(2)} km</strong>`;

    dom.exerciseList.innerHTML = '';
    const hasActivity = entry.exerciseSets > 0 || entry.exerciseMinutes > 0;

    if (hasActivity) {
        const routine = entry.isRestDay ?
            (currentLanguage === 'en' ? stretchingRoutineEN : stretchingRoutineES) :
            (currentLanguage === 'en' ? strengthRoutineEN : strengthRoutineES);
        const numExercises = entry.isRestDay ? routine.length : (entry.numExercises || 0);

        const titleItem = document.createElement('li');
        titleItem.innerHTML = `<strong>${entry.isRestDay ? texts.restDayRoutine : texts.exerciseInstructions} (${numExercises} exercises)</strong>`;
        dom.exerciseList.appendChild(titleItem);

        routine.slice(0, numExercises).forEach(exercise => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<strong>${exercise.name}:</strong> ${exercise.desc}`;
            dom.exerciseList.appendChild(listItem);
        });
    } else {
        dom.exerciseList.innerHTML = `<li>${texts.noExercises}</li>`;
    }
}

// --- CHARTING FUNCTIONS ---
function createChart(canvas, config) {
    if (config.chartInstance) config.chartInstance.destroy();
    return new Chart(canvas.getContext('2d'), config.options);
}

function updateAllCharts() {
    if (dom.progressSection.classList.contains('hidden')) return;
    exerciseChart = createChart(dom.exerciseChartCanvas, getExerciseChartConfig());
    weeklyChart = createChart(dom.weeklyChartCanvas, getWeeklyChartConfig());
}

function getExerciseChartConfig() {
    const graphEntries = diaryEntriesBase.filter(e => !e.isSummary && e.id.startsWith('day-') && parseInt(e.id.replace('day-','')) >= 1);
    const texts = uiTexts[currentLanguage];
    const labels = graphEntries.map(e => e.shortTitle.replace('Day', texts.dayPrefix));
    
    return {
        chartInstance: exerciseChart,
        options: {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: texts.chartLabelSets, data: graphEntries.map(e => (e.exerciseSets || 0) * 5), backgroundColor: '#60a5fa' },
                    { label: texts.chartLabelKcals, data: graphEntries.map(e => (e.moveKcals || 0) / 10), backgroundColor: '#C71585' },
                    { label: texts.chartLabelExerciseMinutes, data: graphEntries.map(e => e.exerciseMinutes || 0), backgroundColor: '#90EE90' },
                    { label: texts.chartLabelWalkDistance, data: graphEntries.map(e => (e.walkDistanceKm || 0) * 10), backgroundColor: '#FFD700' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { tooltip: { callbacks: { label: (ctx) => formatTooltip(ctx, texts) } } },
                scales: { y: { display: false, beginAtZero: true }, x: { grid: { display: false } } }
            }
        }
    };
}

function getWeeklyChartConfig() {
    const weeklyData = calculateWeeklyData();
    const texts = uiTexts[currentLanguage];
    return {
        chartInstance: weeklyChart,
        options: {
            type: 'bar',
            data: {
                labels: weeklyData.map(w => w.name),
                datasets: [
                    { label: texts.chartLabelKcals, data: weeklyData.map(w => w.moveKcals), backgroundColor: '#C71585' },
                    { label: texts.chartLabelExerciseMinutes, data: weeklyData.map(w => w.exerciseMinutes), backgroundColor: '#90EE90' },
                    { label: texts.chartLabelStandHours, data: weeklyData.map(w => w.standHours), backgroundColor: '#60a5fa' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
        }
    };
}

function calculateWeeklyData() {
    const weeklyTotals = {};
    diaryEntriesBase.forEach(entry => {
        if (entry.isSummary || !entry.id.startsWith('day-')) return;
        const dayNum = parseInt(entry.id.replace('day-', ''));
        if (isNaN(dayNum) || dayNum < 1) return;

        const weekNum = Math.ceil(dayNum / 7);
        if (!weeklyTotals[weekNum]) {
            weeklyTotals[weekNum] = { moveKcals: 0, exerciseMinutes: 0, standHours: 0 };
        }
        Object.keys(weeklyTotals[weekNum]).forEach(key => weeklyTotals[weekNum][key] += entry[key] || 0);
    });

    const texts = uiTexts[currentLanguage];
    return Object.entries(weeklyTotals).map(([weekNum, data]) => ({ name: `${texts.weekPrefix} ${weekNum}`, ...data }));
}

function formatTooltip(context, texts) {
    let label = context.dataset.label || '';
    if (label) { label += ': '; }
    if (context.dataset.label === texts.chartLabelSets) return `${label}${context.raw / 5} sets`;
    if (context.dataset.label === texts.chartLabelKcals) return `${label}${context.raw * 10} KCAL`;
    if (context.dataset.label === texts.chartLabelWalkDistance) return `${label}${(context.raw / 10).toFixed(2)} km`;
    return `${label}${context.raw} minutes`;
}

function translateTitle(title) {
    const replacements = { "Surgery Day": "D√≠a de Cirug√≠a", "Back on the Bike!": "¬°De vuelta en la Bicicleta!", "Consistent Progress": "Progreso Constante", "Pushing the Limits": "Superando los L√≠mites", "A Calmer Day": "Un D√≠a M√°s Tranquilo", "Increasing Intensity": "Aumentando la Intensidad", "A Long Walk": "Una Larga Caminata", "Steady Progress": "Progreso Constante", "First Day Home": "Primer D√≠a en Casa" };
    let translatedTitle = title.replace(/Day|Week/g, w => uiTexts.es[`${w.toLowerCase()}Prefix`]).replace(/Monday/g, 'Lunes').replace(/Tuesday/g, 'Martes').replace(/Wednesday/g, 'Mi√©rcoles').replace(/Thursday/g, 'Jueves').replace(/Friday/g, 'Viernes').replace(/Saturday/g, 'S√°bado').replace(/Sunday/g, 'Domingo');
    for (const [en, es] of Object.entries(replacements)) {
        if (translatedTitle.includes(en)) {
            const replacement = translatedTitle.includes("day0-highlight") ? `<span class='day0-highlight'>${es}</span>` : es;
            translatedTitle = translatedTitle.replace(en, replacement).replace(/<span class='day0-highlight'>/g,"").replace(/<\/span>/g,""); // Clean up spans before re-adding
            if (translatedTitle.includes(es) && title.includes("day0-highlight")) {
                 translatedTitle = translatedTitle.replace(es, `<span class='day0-highlight'>${es}</span>`);
            }
        }
    }
    return translatedTitle;
}

// --- EVENT HANDLERS & INITIALIZATION ---
function switchLanguage() {
    currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
    populateDaySelectors();
    updateUIText();
    updateDiaryDisplay();
}

function toggleProgress() {
    dom.progressSection.classList.toggle('hidden');
    updateUIText(); // Updates button text
    if (!dom.progressSection.classList.contains('hidden')) {
        updateAllCharts();
        updateExerciseDetails();
    }
}

dom.prevDayButton.addEventListener('click', () => { if (currentEntryIndex > 0) { currentEntryIndex--; updateDiaryDisplay(); } });
dom.nextDayButton.addEventListener('click', () => { if (currentEntryIndex < orderedEntries.length - 1) { currentEntryIndex++; updateDiaryDisplay(); } });
dom.languageToggleButton.addEventListener('click', switchLanguage);
dom.toggleProgressButton.addEventListener('click', toggleProgress);

document.addEventListener('DOMContentLoaded', () => {
    currentEntryIndex = orderedEntries.findIndex(entry => entry.id === "day-26");
    if (currentEntryIndex === -1) {
        currentEntryIndex = orderedEntries.length - 1;
    }
    populateDaySelectors();
    updateUIText();
    updateDiaryDisplay();
});
</script>
</body>
</html>